<!DOCTYPE html>
<html lang="ko">
<head>
    <link rel="apple-touch-icon" href="icon.png">
<link rel="icon" href="icon.png">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>ì•”ì‚° & ë…íŒŒ í†µí•© ì±”í”¼ì–¸ì‹­</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;700;900&family=Roboto:wght@700;900&display=swap" rel="stylesheet">
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.5.1/dist/confetti.browser.min.js"></script>
    <style>
        :root { 
            --bg: #0f0f0f; --panel: #1a1a1a; --green: #2ecc71; --lightgreen: #a2dd58; 
            --red: #e74c3c; --purple: #9b59b6; --gold: #f1c40f; --pink: #ff69b4; --skyblue: #87ceeb; --deep-purple: #8e44ad;
        }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; user-select: none; margin: 0; padding: 0; touch-action: manipulation; }
        body { 
            font-family: 'Noto Sans KR', sans-serif; 
            background: var(--bg); color: white; overflow: hidden; height: 100vh; width: 100vw; display: flex; flex-direction: column; 
        }
        .game-area, .result-score, #ansDisplay, .rolling-number { font-family: 'Roboto', 'Noto Sans KR', sans-serif; }
        #feedback-mark { position: fixed; top: 40%; left: 50%; transform: translate(-50%, -50%); font-size: 120px; font-weight: bold; z-index: 5000; pointer-events: none; transition: 0.2s; opacity: 0; }
        .show-fb { opacity: 1 !important; transform: translate(-50%, -50%) scale(1.2) !important; }
        #number-stack { transition: all 0.15s; position: relative; width: 100%; height: 100%; display: flex; flex-direction: column; align-items: center; justify-content: center; text-align: center; }
        .rolling-container { position: relative; height: 80vh; width: 250px; overflow: hidden; display: flex; flex-direction: column; align-items: center; }
        .rolling-number { position: absolute; font-size: 10vh; font-weight: 900; color: #fff; opacity: 0; }
        @keyframes rolling-up { 0% { transform: translateY(80vh); opacity: 0; } 10% { opacity: 1; } 90% { opacity: 1; } 100% { transform: translateY(-20vh); opacity: 0; } }
        .geshi-num-last { border-bottom: 5px solid white; padding-bottom: 5px; margin-bottom: 15px; min-width: 150px; }
        .input-guide { font-size: 4vh; color: #888; animation: none; margin-top: 10px; }
        .top-status { height: 45px; display: flex; justify-content: space-between; align-items: center; padding: 0 15px; background: #222; border-bottom: 1px solid #333; flex-shrink: 0; }
        .fs-btn { background: #444; color: #fff; border: none; padding: 5px 10px; border-radius: 5px; font-size: 0.7rem; cursor: pointer; }
        .main-content { flex: 1; display: flex; overflow: hidden; position: relative; }
        .ranking-side { width: 115px; background: var(--panel); border-right: 1px solid #333; display: flex; flex-direction: column; }
        .game-area { flex: 1; background: #000; display: flex; flex-direction: column; align-items: center; justify-content: center; overflow: hidden; position: relative; }
        .rank-box-1 { background: var(--gold) !important; color: #000 !important; }
        .rank-box-2 { background: var(--pink) !important; color: #fff !important; }
        .rank-box-3 { background: var(--skyblue) !important; color: #000 !important; }
        .rank-box-4 { background: var(--deep-purple) !important; color: #fff !important; }
        .rank-box-5 { background: var(--green) !important; color: #000 !important; }
        .rank-box-etc { background: var(--lightgreen) !important; color: #000 !important; }
        .my-rank-highlight { border: 4px solid var(--red) !important; box-shadow: 0 0 15px var(--red); z-index: 10; }
        @keyframes solving-flash { 0% { border-color: #ff0000; box-shadow: 0 0 15px #ff0000; } 33% { border-color: #f1c40f; box-shadow: 0 0 15px #f1c40f; } 66% { border-color: #2ecc71; box-shadow: 0 0 15px #2ecc71; } 100% { border-color: #ff0000; box-shadow: 0 0 15px #ff0000; } }
        .is-solving { animation: solving-flash 0.8s linear infinite !important; border: 5px solid white !important; transform: scale(1.03); z-index: 5; }
        #admin-dashboard { position: absolute; inset: 0; background: #000; padding: 15px; z-index: 500; display: none; overflow-y: auto; column-width: 320px; column-gap: 20px; }
        .dash-row { margin-bottom: 10px; border-radius: 10px; display: flex; align-items: center; justify-content: space-between; padding: 15px; break-inside: avoid; border: 4px solid transparent; transition: all 0.2s; }
        #result-screen { position: absolute; inset: 0; background: rgba(0,0,0,0.98); display: none; flex-direction: column; align-items: center; justify-content: center; z-index: 2000; text-align: center; }
        .result-score { font-size: 5rem; color: var(--green); font-weight: 900; }
        .result-rank-badge { font-size: 2.5rem; color: #fff; background: var(--purple); padding: 10px 30px; border-radius: 50px; margin-top: 20px; font-weight: bold; border: 4px solid var(--gold); }
        #rankList { flex: 1; overflow-y: auto; padding: 5px; -webkit-overflow-scrolling: touch; }
        .rank-item { padding: 8px 10px; margin-bottom: 5px; border-radius: 6px; display: flex; justify-content: space-between; font-size: 0.8rem; color: #000; font-weight: bold; }
        .keypad-side { width: 320px; background: var(--panel); border-left: 1px solid #333; display: flex; flex-direction: column; padding: 10px; }
        #ansDisplay { background: #fff; color: #000; border-radius: 10px; font-size: 2.2rem; height: 65px; min-height: 65px; display: flex; align-items: center; justify-content: center; font-weight: bold; border: 4px solid var(--purple); margin-bottom: 15px; }
        .keypad-row { display: flex; gap: 8px; flex: 1; min-height: 240px; }
        .key-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 6px; flex: 3; }
        .confirm-col { flex: 1; display: flex; flex-direction: column; }
        .key { background: #333; color: white; border: none; border-radius: 10px; font-size: 1.5rem; font-weight: bold; display: flex; align-items: center; justify-content: center; min-height: 55px; cursor: pointer; }
        .key:active { background: #555; transform: scale(0.95); }
        .key-enter { background: var(--green); color: white; border: none; border-radius: 10px; height: 100%; font-size: 1.6rem; font-weight: 900; cursor: pointer; }
        .key-enter:active { background: #27ae60; transform: scale(0.98); }
        #login-box, #waiting-room { position: fixed; inset: 0; background: var(--bg); z-index: 10000; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .btn-large { padding: 15px 40px; border-radius: 12px; border: none; font-weight: bold; font-size: 1.3rem; background: var(--green); color: white; cursor: pointer; }
        input { font-size: 1.5rem; padding: 15px; text-align: center; border-radius: 12px; width: 280px; background: #222; color: white; border: 2px solid #444; margin-bottom: 20px; }
    </style>
</head>
<body>

<div id="feedback-mark"></div>
<div id="login-box">
    <h1 style="color:var(--purple); font-size: 2.5rem; margin-bottom: 20px;">CHAMPIONSHIP</h1>
    <input type="text" id="pName" placeholder="ì„±í•¨ ì…ë ¥">
    <button class="btn-large" onclick="joinGame()">ëŒ€íšŒ ì…ì¥í•˜ê¸°</button>
</div>

<div id="waiting-room" style="display:none;">
    <h1 style="color:var(--purple); margin-bottom: 20px;">ğŸ† ì°¸ê°€ì ëŒ€ê¸°ì‹¤</h1>
    <div id="userGrid" style="display:flex; flex-wrap:wrap; justify-content:center; gap:10px; padding:20px;"></div>
    <div id="admin-controls" style="display:none; margin-top: 20px; gap: 10px;">
        <button class="btn-large" onclick="startGame()">ğŸš€ ëŒ€íšŒ ì‹œì‘</button>
        <button class="btn-large" style="background:#c0392b;" onclick="resetGame()">ğŸ§¹ ë¦¬ì…‹</button>
    </div>
</div>

<div class="top-status">
    <div id="mode-title" style="color: var(--purple); font-weight: bold;">READY</div>
    <button class="fs-btn" onclick="toggleFullScreen()">ì „ì²´í™”ë©´</button>
    <div id="timer" style="color: var(--red); font-weight: 900; font-size: 1.3rem;">05:00</div>
</div>

<div class="main-content" id="mainGame" style="display:none;">
    <div id="admin-dashboard"></div>
    <div class="ranking-side"><div id="rankList"></div></div>
    <div class="game-area">
        <div id="number-stack">Ready</div>
        <canvas id="abacus-canvas" style="display:none;"></canvas>
        <div id="result-screen">
            <div class="result-title" style="font-size: 1.5rem; color: #fff;">ğŸŠ ì •ë§ í›Œë¥­í•´ìš”! ğŸŠ</div>
            <div class="result-score" id="final-score">0</div>
            <div class="result-rank-badge" id="final-rank-text">ìˆœìœ„ ê³„ì‚° ì¤‘...</div>
            <button class="btn-large" style="margin-top:20px; background:var(--panel);" onclick="location.reload()">ë‹¤ì‹œí•˜ê¸°</button>
        </div>
    </div>
    <div class="keypad-side" id="keypad-area">
        <div id="ansDisplay">&nbsp;</div>
        <div class="keypad-row">
            <div class="key-grid">
                <button class="key" onclick="press(1)">1</button><button class="key" onclick="press(2)">2</button><button class="key" onclick="press(3)">3</button>
                <button class="key" onclick="press(4)">4</button><button class="key" onclick="press(5)">5</button><button class="key" onclick="press(6)">6</button>
                <button class="key" onclick="press(7)">7</button><button class="key" onclick="press(8)">8</button><button class="key" onclick="press(9)">9</button>
                <button class="key key-util" onclick="press('AC')">AC</button><button class="key" onclick="press(0)">0</button><button class="key key-util" onclick="press('C')">â†</button>
            </div>
            <div class="confirm-col"><button class="key-enter" onclick="checkAnswer()">í™•<br><br>ì¸</button></div>
        </div>
        <div style="min-height: 40px;"></div>
    </div>
</div>

<script>
    const firebaseConfig = { apiKey: "AIzaSyC_4d0OaqFZpu2bgDTp8xd8DqVMUNeBtag", databaseURL: "https://youn-seam-default-rtdb.firebaseio.com", projectId: "gen-lang-client-0966863855", appId: "1:57879904264:android:4471fde978fc4a5e6251bd" };
    if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    let myName, myScore = 0, currentIdx = 0, questions = [], targetAns = 0, timerId = null, isFinished = false, audioCtx = null;

    function initAudio() { if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)(); }
    
    function playSfx(type) {
        if(!audioCtx) return;
        const o = audioCtx.createOscillator();
        const g = audioCtx.createGain();
        o.connect(g); g.connect(audioCtx.destination);
        const now = audioCtx.currentTime;

        if(type === 'start') { o.type = 'triangle'; o.frequency.setValueAtTime(440, now); o.frequency.exponentialRampToValueAtTime(880, now + 0.5); g.gain.setValueAtTime(0.1, now); g.gain.linearRampToValueAtTime(0, now + 0.5); o.start(); o.stop(now + 0.5); }
        else if(type === 'tick') { o.type = 'sine'; o.frequency.setValueAtTime(1200, now); g.gain.setValueAtTime(0.05, now); g.gain.linearRampToValueAtTime(0, now + 0.05); o.start(); o.stop(now + 0.05); }
        else if(type === 'next') { o.type = 'sine'; o.frequency.setValueAtTime(660, now); g.gain.setValueAtTime(0.05, now); g.gain.linearRampToValueAtTime(0, now + 0.2); o.start(); o.stop(now + 0.2); }
        else if(type === 'correct') { o.frequency.setValueAtTime(880, now); o.frequency.exponentialRampToValueAtTime(1320, now + 0.1); g.gain.setValueAtTime(0.1, now); g.gain.linearRampToValueAtTime(0, now + 0.1); o.start(); o.stop(now + 0.1); }
        else if(type === 'finish') { [523.25, 659.25, 783.99].forEach((f, i) => { const osc = audioCtx.createOscillator(); const gain = audioCtx.createGain(); osc.connect(gain); gain.connect(audioCtx.destination); osc.frequency.setValueAtTime(f, now + (i * 0.1)); gain.gain.setValueAtTime(0.05, now + (i * 0.1)); gain.gain.exponentialRampToValueAtTime(0.01, now + 0.8); osc.start(now + (i * 0.1)); osc.stop(now + 0.8); }); }
    }

    function calculateRanks(sortedPlayers) {
        let ranks = []; let currentRank = 1;
        for (let i = 0; i < sortedPlayers.length; i++) {
            if (i > 0 && sortedPlayers[i][1].score < sortedPlayers[i - 1][1].score) currentRank = i + 1;
            ranks.push({ name: sortedPlayers[i][0], score: sortedPlayers[i][1].score, isDone: sortedPlayers[i][1].isDone, rank: currentRank });
        }
        return ranks;
    }

    function getRankClass(rank) {
        if(rank === 1) return 'rank-box-1'; if(rank === 2) return 'rank-box-2'; if(rank === 3) return 'rank-box-3';
        if(rank === 4) return 'rank-box-4'; if(rank === 5) return 'rank-box-5'; return 'rank-box-etc';
    }

    function updateRankList(rankedData) {
        const list = document.getElementById('rankList'); if(!list) return;
        list.innerHTML = rankedData.map(item => `
            <div class="rank-item ${getRankClass(item.rank)} ${item.name === myName ? 'my-rank-highlight' : ''}">
                <span>${item.rank}.${item.name.substring(0,4)}</span><span>${item.score}</span>
            </div>`).join("");
        if(isFinished) {
            const myInfo = rankedData.find(r => r.name === myName);
            if(myInfo) document.getElementById('final-rank-text').innerText = `${myInfo.rank} ìœ„`;
        }
    }

    function updateAdminDashboard(rankedData) {
        const dash = document.getElementById('admin-dashboard'); if(!dash || dash.style.display === 'none') return;
        dash.innerHTML = rankedData.map(item => {
            const isSolving = item.isDone === false;
            return `<div class="dash-row ${getRankClass(item.rank)} ${isSolving ? 'is-solving' : ''}">
                <div class="dash-rank">${item.rank}ìœ„</div>
                <div class="dash-name">${item.name} ${isSolving ? 'âœï¸' : 'ğŸ†'}</div>
                <div class="dash-score">${item.score}ì </div>
            </div>`;
        }).join("");
    }

    function toggleFullScreen() { if (!document.fullscreenElement) document.documentElement.requestFullscreen().catch(e=>{}); }

    function joinGame() {
        initAudio(); myName = document.getElementById('pName').value.trim();
        if(!myName) return alert("ì´ë¦„!"); toggleFullScreen();
        document.getElementById('login-box').style.display = 'none';
        document.getElementById('waiting-room').style.display = 'flex';
        if(myName === 'ì„ ìƒë‹˜') document.getElementById('admin-controls').style.display = 'flex';
        else db.ref('players/' + myName).set({ score: 0, isDone: false });
        db.ref('players').on('value', snap => {
            const p = snap.val() || {};
            const sorted = Object.entries(p).filter(([n])=>n!=='ì„ ìƒë‹˜').sort((a,b)=>b[1].score - a[1].score);
            const rankedData = calculateRanks(sorted);
            updateRankList(rankedData);
            if(myName === 'ì„ ìƒë‹˜') updateAdminDashboard(rankedData);
        });
        db.ref('status').on('value', snap => { if(snap.val() === 'start') goGame(); else if(snap.val() === 'reset') location.reload(); });
    }

    function goGame() {
        document.getElementById('waiting-room').style.display = 'none';
        document.getElementById('mainGame').style.display = 'flex';
        if(myName === 'ì„ ìƒë‹˜') {
            document.getElementById('admin-dashboard').style.display = 'block';
            document.getElementById('keypad-area').style.display = 'none';
            document.querySelector('.ranking-side').style.display = 'none';
            document.querySelector('.game-area').style.display = 'none';
        } else if(!timerId) {
            playSfx('start');
            startApp();
        }
    }

    function startGame() { db.ref('status').set('start'); }
    function resetGame() { if(confirm("ì´ˆê¸°í™”?")) db.ref().remove().then(()=>location.reload()); }
    
    function press(n) {
        const d = document.getElementById('ansDisplay'); let t = d.innerText.trim();
        if (n === 'C') d.innerText = t.slice(0, -1) || "\u00A0";
        else if (n === 'AC') d.innerText = "\u00A0";
        else if (t.length < 8) { 
            d.innerText = (t === "\u00A0" ? "" : t) + n; 
            initAudio(); const o=audioCtx.createOscillator(); const g=audioCtx.createGain();
            o.connect(g); g.connect(audioCtx.destination);
            o.frequency.setValueAtTime(1000, audioCtx.currentTime);
            g.gain.setValueAtTime(0.02, audioCtx.currentTime);
            o.start(); o.stop(audioCtx.currentTime+0.03);
        }
    }

    function startApp() {
        questions = make65Questions(); let timeLeft = 300;
        timerId = setInterval(() => {
            timeLeft--; let m=Math.floor(timeLeft/60), s=timeLeft%60;
            document.getElementById('timer').innerText = `${m}:${s<10?'0'+s:s}`;
            if(timeLeft <= 0) finishGame();
        }, 1000);
        nextQuestion();
    }

    async function nextQuestion() {
        if(currentIdx >= 65 || isFinished) return finishGame();
        const q = questions[currentIdx]; 
        const display = document.getElementById('number-stack');
        document.getElementById('ansDisplay').innerText = "\u00A0"; 
        document.getElementById('abacus-canvas').style.display = 'none';
        display.style.display = 'flex';

        if(currentIdx === 44) {
            playSfx('start');
            display.style.color = "var(--gold)"; display.style.fontSize = "6vh";
            display.innerHTML = "ğŸ†<br>ì§€ê¸ˆë¶€í„°ëŠ” ì±”í”¼ì–¸ ë¬¸ì œ ë„ì „!!<br>í™”ì´íŒ…!";
            await new Promise(r => setTimeout(r, 2000));
        }

        playSfx('next');
        display.style.color = "var(--purple)"; display.style.fontSize = "8vh";
        targetAns = q.ans; 
        display.innerHTML = (currentIdx + 1 > 44) ? "ğŸ† ì±”í”¼ì–¸ ë„ì „!<br>[" + q.type + "]" : `[${q.type}]`;
        await new Promise(r => setTimeout(r, 800));
        if(isFinished) return;
        
        display.style.color = "var(--green)"; display.style.fontSize = "15vh";
        document.getElementById('mode-title').innerText = `${q.type} ${currentIdx+1}/65`;
        
        if(q.type === 'ë¡¤ë§ì•”ì‚°') {
            display.innerHTML = '<div class="rolling-container" id="rolling-box"></div>';
            const box = document.getElementById('rolling-box');
            playSfx('tick'); // â˜… ë¡¤ë§ ì•”ì‚° ì‹œì‘ ì‹œ ì²˜ìŒì— ë”± í•œ ë²ˆë§Œ ì¬ìƒ â˜…
            const interval = q.rollingTime / q.nums.length * 1000;
            for(let i=0; i<q.nums.length; i++) {
                if(isFinished) return;
                const numEl = document.createElement('div');
                numEl.className = 'rolling-number';
                numEl.innerText = q.nums[i];
                numEl.style.animation = `rolling-up ${q.rollingTime}s linear forwards`;
                box.appendChild(numEl);
                await new Promise(r => setTimeout(r, interval));
            }
            await new Promise(r => setTimeout(r, q.rollingTime * 500)); 
            display.style.fontSize = "5vh"; display.innerHTML = "ë‹µì„ ì…ë ¥í•˜ì„¸ìš”";
        } else if(q.type === 'í”Œë˜ì‰¬ì•”ì‚°') {
            for(let num of q.nums) { 
                if(isFinished) return; 
                playSfx('tick');
                display.innerText = num; 
                await new Promise(r => setTimeout(r, q.speed * 1000)); 
                display.innerText = ""; 
                await new Promise(r => setTimeout(r, 60)); 
            }
            display.style.fontSize = "5vh"; display.innerText = "ë‹µì„ ì…ë ¥í•˜ì„¸ìš”";
        } else if(q.type === 'ì£¼íŒì½ê¸°') {
            drawAbacus(q.ans, q.digits);
            await new Promise(r => setTimeout(r, 1500));
            document.getElementById('abacus-canvas').style.display = 'none';
            display.style.display = 'flex'; display.style.fontSize = "4vh";
            display.innerText = "ë‹µì„ ì…ë ¥í•˜ì„¸ìš”";
        } else if(q.type === 'ìˆ«ìì½ê¸°') {
            display.innerText = q.ans;
            await new Promise(r => setTimeout(r, q.showTime * 1000));
            display.style.fontSize = "4vh"; display.innerText = "ë‹µì„ ì…ë ¥í•˜ì„¸ìš”";
        } else if(q.type === 'ê²Œì‹œì•”ì‚°') { 
            let html = "";
            q.nums.forEach((n, i) => {
                if(i === q.nums.length - 1) html += `<div class="geshi-num-last">${n}</div>`;
                else html += `<div>${n}</div>`;
            });
            html += `<div class="input-guide">ë‹µì„ ì…ë ¥í•˜ì„¸ìš”</div>`;
            display.innerHTML = html; display.style.fontSize = "8vh"; 
        }
    }

    function checkAnswer() {
        const input = document.getElementById('ansDisplay').innerText.trim();
        if(!input || isFinished) return;
        const fb = document.getElementById('feedback-mark');
        fb.classList.remove('show-fb'); void fb.offsetWidth; 
        if(parseInt(input) === targetAns) { 
            myScore += questions[currentIdx].point; 
            fb.innerText = "âœ“"; fb.style.color = "var(--green)"; 
            playSfx('correct');
        } else { 
            fb.innerText = "âœ—"; fb.style.color = "var(--red)"; 
            const o=audioCtx.createOscillator(); const g=audioCtx.createGain();
            o.connect(g); g.connect(audioCtx.destination);
            o.frequency.setValueAtTime(200, audioCtx.currentTime);
            g.gain.setValueAtTime(0.1, audioCtx.currentTime);
            o.start(); o.stop(audioCtx.currentTime+0.2);
        }
        fb.classList.add('show-fb');
        setTimeout(() => fb.classList.remove('show-fb'), 500);
        currentIdx++; 
        db.ref('players/' + myName).update({ score: myScore, isDone: (currentIdx >= 65) });
        if(currentIdx >= 65) finishGame(); else nextQuestion();
    }

    function drawAbacus(num, digits) {
        const canvas = document.getElementById('abacus-canvas'); const ctx = canvas.getContext('2d');
        const w = 70 * digits, h = 280; canvas.width = w; canvas.height = h; canvas.style.display = 'block';
        document.getElementById('number-stack').style.display = 'none';
        ctx.clearRect(0,0,w,h);
        ctx.fillStyle = "#fff"; ctx.fillRect(0, 76, w, 8); 
        const strNum = num.toString().padStart(digits, '0');
        for(let i=0; i<digits; i++) {
            let x = i * 70 + 35, val = parseInt(strNum[i]);
            ctx.strokeStyle = "#444"; ctx.lineWidth = 2; ctx.beginPath(); ctx.moveTo(x, 0); ctx.lineTo(x, h); ctx.stroke();
            ctx.fillStyle = "#2ecc71"; ctx.strokeStyle = "#1b5e20"; ctx.lineWidth = 2;
            if(val >= 5) { ctx.beginPath(); ctx.ellipse(x, 62, 30, 14, 0, 0, Math.PI*2); ctx.fill(); ctx.stroke(); }
            let loCnt = val % 5;
            for(let j=1; j<=loCnt; j++) { let y = 84 + (j * 30) - 15; ctx.beginPath(); ctx.ellipse(x, y, 30, 14, 0, 0, Math.PI*2); ctx.fill(); ctx.stroke(); }
        }
    }

    function make65Questions() {
        let qs = [];
        const rnd = (d) => Math.floor(Math.random() * (Math.pow(10, d) - Math.pow(10, d-1))) + Math.pow(10, d-1);
        for(let i=0; i<3; i++) { let n=[rnd(1),rnd(1),rnd(1)]; if(i==2) n.push(rnd(1)); qs.push({type:'ê²Œì‹œì•”ì‚°', nums:n, ans:n.reduce((a,b)=>a+b,0), point:1}); }
        const f = (d,r,s,p) => { let n=Array.from({length:r},()=>rnd(d)); return {type:'í”Œë˜ì‰¬ì•”ì‚°', nums:n, ans:n.reduce((a,b)=>a+b,0), speed:s, point:p}; };
        qs.push(f(1,3,0.8,1), f(1,4,0.8,1), f(1,5,0.7,1), f(1,5,0.6,1));
        const r = (d,r,t,p) => { let n=Array.from({length:r},()=>rnd(d)); return {type:'ë¡¤ë§ì•”ì‚°', nums:n, ans:n.reduce((a,b)=>a+b,0), rollingTime:t, point:p}; };
        qs.push(r(1,5,2,1), r(1,5,2,1), r(1,7,2,1), r(1,7,2,1), r(1,10,3,1));
        let abSet = [{d:3,p:1},{d:3,p:1},{d:4,p:1},{d:4,p:1},{d:5,p:1},{d:5,p:1},{d:6,p:1},{d:7,p:1}].sort(()=>Math.random()-0.5);
        abSet.forEach(a=>qs.push({type:'ì£¼íŒì½ê¸°', digits:a.d, ans:rnd(a.d), point:a.p}));
        for(let i=0; i<3; i++) { let n=Array.from({length:3+i},()=>rnd(2)); qs.push({type:'ê²Œì‹œì•”ì‚°', nums:n, ans:n.reduce((a,b)=>a+b,0), point:2}); }
        qs.push(f(2,3,0.7,2), f(2,4,0.7,2), f(2,5,0.6,2));
        qs.push(r(2,5,2,2), r(2,5,2,2), r(2,7,2,2), r(2,7,2,2));
        qs.push({type:'ìˆ«ìì½ê¸°', ans:rnd(3), showTime:2, point:1}, {type:'ìˆ«ìì½ê¸°', ans:rnd(3), showTime:2, point:1});
        qs.push({type:'ìˆ«ìì½ê¸°', ans:rnd(4), showTime:2, point:1}, {type:'ìˆ«ìì½ê¸°', ans:rnd(4), showTime:1.5, point:1});
        qs.push({type:'ìˆ«ìì½ê¸°', ans:rnd(5), showTime:1.5, point:1}, {type:'ìˆ«ìì½ê¸°', ans:rnd(5), showTime:1.5, point:1});
        qs.push({type:'ìˆ«ìì½ê¸°', ans:rnd(6), showTime:1, point:1}, {type:'ìˆ«ìì½ê¸°', ans:rnd(6), showTime:1, point:1});
        qs.push({type:'ìˆ«ìì½ê¸°', ans:rnd(7), showTime:1, point:1}, {type:'ìˆ«ìì½ê¸°', ans:rnd(7), showTime:1, point:1});
        for(let i=0; i<3; i++) { let n=Array.from({length:3+i},()=>rnd(3)); qs.push({type:'ê²Œì‹œì•”ì‚°', nums:n, ans:n.reduce((a,b)=>a+b,0), point:2}); }
        qs.push(f(2,5,0.5,2), f(2,7,0.5,2), f(3,5,0.7,2), f(3,5,0.6,2), f(3,7,0.5,2));
        qs.push(r(2,7,1.5,2), r(2,7,1.5,2), r(2,10,1.5,2), r(3,5,1.5,2), r(3,7,2,2), r(3,10,2,2));
        for(let i=0; i<3; i++) { let n=Array.from({length:3+i},()=>rnd(4)); qs.push({type:'ê²Œì‹œì•”ì‚°', nums:n, ans:n.reduce((a,b)=>a+b,0), point:2}); }
        qs.push(f(3,10,0.7,2), f(3,10,0.5,2), f(4,5,0.8,2), f(4,5,0.7,2), f(4,7,0.7,2));
        qs.push(r(2,10,1.5,2), r(2,10,1.5,2), r(3,10,2,2), r(4,10,3,2));
        return qs;
    }

    function finishGame() { 
        if(isFinished) return; isFinished = true; clearInterval(timerId); playSfx('finish'); 
        document.getElementById('final-score').innerText = myScore;
        document.getElementById('result-screen').style.display = 'flex';
        document.getElementById('keypad-area').style.display = 'none';
        confetti({ particleCount: 150, spread: 70, origin: { y: 0.6 } });
        db.ref('players/' + myName).update({ score: myScore, isDone: true });
        db.ref('players').once('value', snap => {
            const p = snap.val() || {};
            const sorted = Object.entries(p).filter(([n])=>n!=='ì„ ìƒë‹˜').sort((a,b)=>b[1].score - a[1].score);
            const rankedData = calculateRanks(sorted);
            const myInfo = rankedData.find(r => r.name === myName);
            if(myInfo) document.getElementById('final-rank-text').innerText = `${myInfo.rank} ìœ„`;
        });
    }
</script>
</body>

</html>
